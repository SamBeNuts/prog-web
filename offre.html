<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Emna">
    <meta name="author" content="Ha">
    <meta name="author" content="Jin Yu">
    <meta name="author" content="Samuel">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INSA - Prog Web</title>
    <link rel="icon" href="img/favicon-96x96.png" type="image/png" sizes="96x96">
    <link rel="stylesheet" type="text/css" href="css/base.css">
    <link rel="stylesheet" type="text/css" href="css/offre.css">
</head>
<body>
<div id="wrapper">
    <header>
        <img src="img/header_bg_offers.jpg" class="bg">
		<a href="index.html"><img src="img/logo_insa_w.png" class="logo_insa"></a>
        <nav role="navigation">
            <div class="menuToggle" onclick="menuToggle(this)">
                <div class="line1"></div>
                <div class="line2"></div>
                <div class="line3"></div>
            </div>
            <ul class="menuItems">
                <li><a href="index.html" class="text_white text_shadow">Accueil</a></li>
                <li><a href="offre.html" class="text_white text_shadow">Écoles partenaires</a></li>
                <li><a href="procedure.html" class="text_white text_shadow">Procédure</a></li>
                <li><a href="simu.html" class="text_white text_shadow">Simulation budget</a></li>
                <li><a href="FAQ.html" class="text_white text_shadow">FAQ</a></li>
                <!--<li>FR/EN</li>-->
            </ul>
        </nav>
        <div class="filter">
            <select class="filter_search year" onchange="filter()">
                <option value="">Année</option>
            </select>
            <select class="filter_search department" onchange="filter()">
                <option value="">Orientation</option>
            </select>
            <select class="filter_search language" onchange="filter()">
                <option value="">Langue du Cours</option>
            </select>
            <select class="filter_search country" onchange="filter()">
                <option value="">Pays</option>
            </select>
        </div>
    </header>
	<div class="content">
        <input class="research" type="text" placeholder="Filtrer par nom" onkeyup="filter()">
        <!--<div class="number">-->
            <!--<div class="line"></div>-->
            <!--<p class="nb_result"></p>-->
        <!--</div>-->
        <div class="favoris">
        </div>
		<div class="schools active">
		</div>
	</div>
    <div class="favori_btn" onclick="favoriToggle()">
        <img src="img/favorite.png">
    </div>
    <footer>
        <p class="text_white">Thème, design et code réalisés par <span>E</span>mna, <span>H</span>a,
            <span>J</span>in <span>Y</span>u et <span>S</span>amuel - <a href="sitemap.html" class="text_white">plan
                du site</a></p>
    </footer>
</div>
<script type="text/javascript" src="js/request_data.js"></script>
<script type="text/javascript" src="js/cookies.js"></script>
<script type="text/javascript">
    function menuToggle(x) {
        x.parentElement.classList.toggle("active"); //rajoute/enlève la classe active du burger menu
    }

    function favoriToggle() {
        document.querySelector(".favori_btn").classList.toggle("active"); //rajoute/enlève la classe active du bouton de favoris
        document.querySelector(".favoris").classList.toggle("active"); //rajoute/enlève la classe active des écoles mises en favoris
        document.querySelector(".schools").classList.toggle("active"); //rajoute/enlève la classe active de toutes les écoles
    }

	request.onload = function () { //attend que les données de data.json soient récupérées
        let data = request.response; //on récupère toutes les données de data.json
        let cookies = getCookie('favoris'); //on récupère la valeur du cookie favoris (un tableau avec les écoles mises en favoris)
        add_filters(data.years, data.years, '.year'); //on rajoute les options des filtres pour les années
        add_filters(data.orientations, data.orientations, '.department'); //on rajoute les options des filtres pour les orientations
        add_filters(data.languages_abbr, data.languages, '.language'); //on rajoute les options des filtres pour les langues
        add_filters(data.countries, data.countries, '.country'); //on rajoute les options des filtres pour les pays
        add_schools(data.schools, Object.keys(data.schools), '.schools');
        if (cookies.toString() !== "") add_schools(data.schools, cookies, '.favoris'); //si les cookies ne sont pas vides, on ajoute les écoles mises en favoris
        else document.querySelector(".favori_btn").style.display = 'none'; //sinon on fait disparaître le bouton de favoris
		//document.querySelector(".nb_result").innerHTML = Object.keys(data.schools).length + ' résultats';
    };

    function add_filters(tab_value, tab, container){ //rajoute les options des filtres, tab_value: la value de l'option, tab: le texte de l'option et container: le select qui recevra les options
        for (let i = 0; i<tab.length; i++) document.querySelector(container).innerHTML += "<option value=" + tab_value[i] + ">" + tab[i] + "</option>";
    }

    function add_schools(schools, schools_name, container) {
        let school_0 = "<a href='offre_details.html?school="; //rajoute un lien hypertexte vers lécole concernée
        let school_1 = "'><div class='school'><img class='image' src='img/data/"; //rajoute l'image de l'école
        let school_2 = "'/><div class='over'><div class='info'><p class='text_white'><img src='img/student_icon.png'> "; //rajoute le hover qui contient les informations sur chaque école //rajoute l'image symbole pour spécifier les niveaux qui concernent l'école
        let school_3 = "</p><p class='text_white'><img src='img/rank_icon.png'> the top "; //rajoute l'image symbole pour spécifier le classement minimum que doit avoir l'étudiant pour accéder à l'école
        let school_4 = "%</p><p class='text_white'><img src='img/language_icon.png'> "; //rajoute l'image symbole pour spécifier les langues des cours enseignés
        let school_5 = " courses</p><p class='text_white'><img src='img/budget_estimated_"; //rajoute l'image symbole pour estimer le budget
        let school_6 = ".png'/> estimated</p></div><div class='visit'><img src='img/visit_btn.png'></div></div><p class='text_white name'>"; //rajoute le symbole flêche qui permet d'accéder à la page détaillée de l'école
        let school_7 = "</p><div class='city'><div class='line'></div><p class='text_white'>";
        let school_8 = "</p></div></div></a>";

        for(let i=0; i<schools_name.length; i++){ //pour chaque école:
            let school = schools_name[i]; // on récupére le nom de l'école
            let b = 2; // L'estimation du budget est représenté sous forme de 3 €. Elle est initialisée à Estimation moyenne : 2 € foncés et 1 € clair. Plus il y a des € foncés et plus l'estimation est élévée.
            if(schools[school].tuiton_cost + schools[school].campus_cost + schools[school].accomodation_cost < 750) b = 1; // Si le budget nécessaire est bas, on affiche 1 € foncé et 2 € clairs.
            else if(schools[school].tuiton_cost + schools[school].campus_cost + schools[school].accomodation_cost > 1500) b = 3; // Si le budget nécessaire est élevé, on affiche 3 € foncés.
            document.querySelector(container).innerHTML += school_0 + school + school_1 + school.toLowerCase().replace(/ /g, '_') + '_thumbnail.jpg' //school.toLowerCase().replace(/ /g, '_') + '_thumbnail.jpg' : rajoute l'image qui représente l'école + l'extention commune aux images
                + school_2 + schools[school].courses_year.join(', ') // schools[school].courses_year.join(', ') : rajoute les niveaux qui concernent l'école
                + school_3 + schools[school].top // schools[school].top : rajoute le classement nécessaire pour l'accès à l'école
                + school_4 + schools[school].courses_languages.join(', ') // schools[school].courses_languages.join(', ') : rajoute les différentes langues des cours enseignés
                + school_5 + b // b : rajoute l'estimation de budget nécessaire pour l'école
                + school_6 + school + school_7 + schools[school].city + ", " // schools[school].city : rajoute la ville de l'école
                + schools[school].country //rajoute le pays de l'école
                + school_8;
        }
    }

    function filter(){
        let research = document.querySelector('.research').value; //récupére le texte saisi par l'utilisateur dans la barre de recherche qui correspond au filtre par nom
        let year = document.querySelector('.filter .year').value; //récupere l'année séléctionnée par l'utilisateur
        let department = document.querySelector('.filter .department').value; //récupere le département séléctionné par l'utilisateur
        let language = document.querySelector('.filter .language').value; //récupere la langue séléctionnée par l'utilisateur
        let country = document.querySelector('.filter .country').value; //récupere le pays séléctionné par l'utilisateur
        let schools = document.querySelectorAll('.school');//récupére le carré de chaque école
        let school_name = document.querySelectorAll('.school .name'); //récupere les noms des écoles dans le carré de chaque école
        let school_city = document.querySelectorAll('.school .city'); //récupere la ville de l'école contenue dans le carré de chaque école
        let school_infos = document.querySelectorAll('.school .over .info'); //récupere les informations spécifiques de l'école dans le hover
        for (let i=0; i < schools.length; i++){ //pour chaque école :
            if (!school_name[i].innerHTML.toLowerCase().includes(research.toLowerCase()) || //applique les filtres sur le nom de l'école
                !school_infos[i].children[0].innerHTML.toLowerCase().includes(year.toLowerCase()) || //applique les filtres sur les années (niveaux)
                !school_infos[i].children[0].innerHTML.toLowerCase().includes(department.toLowerCase()) || //applique les filtres sur les départements (orientations)
                !school_infos[i].children[2].innerHTML.toLowerCase().slice(0,-7).includes(language.toLowerCase()) || //applique les filtres sur les langues
                !school_city[i].innerHTML.toLowerCase().includes(country.toLowerCase())){ //applique les filtres sur les villes
                schools[i].style.display = 'none'; //si les filtres ne correspondant à aucune information dans le json, on n'affiche rien
            }else{
                schools[i].style.display = 'inline-block';
            }
        }
    }
</script>
</body>
</html>